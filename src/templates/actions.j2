{% extends "base.html" %}
{% block title %}Your Actions{% endblock %}
{% block head %}
    <link rel="stylesheet"
          href="{{ url_for('static', filename='css/actions.css') }}">
{% endblock %}
{% block content %}
    <div class="actions-header">
        <h1>Your Actions</h1>
    </div>
    <a href="{{ url_for("action.new_action") }}" class="new-action-btn">+ New Action</a>
    {% if actions %}
        <ul class="action-list">
            {% for act in actions %}
                <li class="action-card">
                    <div class="action-title">{{ act.name }}</div>
                    {% if act.notes %}<div class="action-notes">{{ act.notes }}</div>{% endif %}
                    {% if act.properties %}
                        <details class="action-properties">
                            <summary>Properties</summary>
                            <ul>
                                {% for key, value in act.properties.items() %}
                                    <li>
                                        <strong>{{ key|capitalize }}:</strong> {{ value }}
                                    </li>
                                {% endfor %}
                            </ul>
                        </details>
                    {% endif %}
                    <div class="action-links">
                        <a href="{{ url_for('action.log_activity', action_id=act.id) }}">Add Log</a>
                        <a href="{{ url_for('action.view_action_history', action_id=act.id) }}">View</a>
                        <a href="{{ url_for('dashboard.activity_summary', action_id=act.id) }}">Graph</a>
                        <a href="{{ url_for('action.edit_action', action_id=act.id) }}">Edit</a>
                        <button class="btn btn-danger" onclick="deleteAction({{ act.id }})">Delete Action</button>
                    </div>
                </li>
            {% endfor %}
        </ul>
    {% else %}
        <p class="empty-message">
            No actions yet. <a href="{{ url_for("action.new_action") }}">Create one</a>.
        </p>
    {% endif %}
    <script>
        const apiToken = "{{ current_user().api_token }}"; // pass API token from Flask

        async function deleteAction(actionId) {
            if (!confirm('Are you sure you want to delete this action and all its logs?')) return;

            const response = await fetch(`/api/actions/${actionId}`, {
                method: 'DELETE',
                headers: {
                    'Authorization': `Bearer ${apiToken}`
                }
            });
            const data = await response.json();

            if (response.ok) {
                alert(data.message);
                window.location.href = '{{ url_for("action.list_actions") }}';
            } else {
                alert(data.error);
            }
        }
    </script>
{% endblock %}
