{% extends "base.html" %}
{% block title %}
    {{ action.name }} - Activity Details
{% endblock title %}
{% block head %}
    <link rel="stylesheet"
          href="{{ url_for('static', filename='css/view_action_history.css') }}">
{% endblock head %}
{% block content %}
    <div class="action-header">
        <h1>{{ action.name }}</h1>
        {% if action.notes %}<p>{{ action.notes }}</p>{% endif %}
    </div>
    <div class="action-buttons">
        <a href="{{ url_for('action.log_activity', action_id=action.id) }}">Add Log</a>
        <a href="{{ url_for('action.list_actions') }}" class="secondary">← Back</a>
        <button class="btn btn-danger" onclick="deleteAction({{ action.id }})">Delete Action</button>
    </div>
    {% if action.properties %}
        <details class="properties">
            <summary>General Properties</summary>
            <ul>
                {% for key, value in action.properties.items() %}
                    <li>
                        <strong>{{ key|capitalize }}:</strong> {{ value }}
                    </li>
                {% endfor %}
            </ul>
        </details>
    {% endif %}
    <h2>Recent Logs</h2>
    <div class="logs-list">
        {% if logs %}
            {% for log in logs %}
                <div class="log-entry" id="log-{{ log.id }}">
                    <div class="log-meta">
                        <span>{{ log.timestamp.strftime("%d-%m-%Y %H:%M:%S") }}</span>
                        <div class="log-actions">
                            <span class="log-delta">▲{{ log.delta }}</span>
                            <button class="btn btn-sm btn-info"
                                    onclick="window.location.href='{{ url_for("action.edit_activity", log_id=log.id) }}'">
                                Edit
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteLog({{ log.id }})">Delete</button>
                        </div>
                    </div>
                    {% if log.notes %}<div class="log-notes">{{ log.notes }}</div>{% endif %}
                    {% if log.properties %}<pre>{{ log.properties | tojson(indent=2) }}</pre>{% endif %}
                </div>
            {% endfor %}
        {% else %}
            <p>No logs yet. Add one!</p>
        {% endif %}
    </div>
    <script>
const apiToken = "{{ current_user().api_token }}";
const csrfToken = "{{ csrf_token() }}";

async function deleteAction(actionId) {
    if (!confirm('Are you sure you want to delete this action and all its logs?')) return;

    const response = await fetch(`/api/delete/action/${actionId}`, {
        method: 'DELETE',
        headers: { 'Authorization': `Bearer ${apiToken}`, 'X-CSRFToken': csrfToken }
    });
    const data = await response.json();

    if (response.ok) {
        alert(data.message);
        window.location.href = '{{ url_for("action.list_actions") }}';
    } else {
        alert(data.error);
    }
}

async function deleteLog(logId) {
    if (!confirm('Are you sure you want to delete this log?')) return;

    const response = await fetch(`/api/delete/log/${logId}`, {
        method: 'DELETE',
        headers: { 'Authorization': `Bearer ${apiToken}`, 'X-CSRFToken': csrfToken }
    });
    const data = await response.json();

    if (response.ok) {
        alert(data.message);
        document.getElementById(`log-${logId}`).remove();
    } else {
        alert(data.error);
    }
}
    </script>
{% endblock content %}
